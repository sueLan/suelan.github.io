<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="RY&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" type="image/ico" href="[object Object]"/>
  
  <title>
    
      Dive into react native module | RY &#39;s Blog
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 5.2.0"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>RY 's Blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/series/" class="item-link">Series</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/series/" class="menu-link">Series</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>Dive into react native module</h2>
  <p class="post-date">2020-12-23</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p><a target="_blank" rel="noopener" href="https://reactnative.dev/docs/native-modules-ios">Native Modules</a> is one of the key part of React Native which enables JavasScript to call methods in iOS or Android native implementation.</p>
<p> It is quite interesting to explore the source code about native modules in react native repo. In this article, I would like to talk something about how React Native register, initialize native modules and what is behind the method calling from JavaScript side to iOS Objective-C modules. </p>
<p>First of all, letâ€™s take look at <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/23717e48aff3d7fdaea30c9b8dcdd6cfbb7802d5/React/Base/RCTBridgeModule.h#L63">RCTBridgeModule`</a> , which is a protocol provides interface needed to register a bridge module.   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#define RCT_EXPORT_MODULE(js_name)  </span><br><span class="line">#define RCT_EXPORT_METHOD(method)</span><br><span class="line">+ (NSString *)moduleName;</span><br><span class="line"></span><br><span class="line">@optional</span><br><span class="line">+ (BOOL)requiresMainQueueSetup;</span><br></pre></td></tr></table></figure>
<h2 id="Export-and-Register-Modules"><a href="#Export-and-Register-Modules" class="headerlink" title="Export and Register Modules"></a>Export and Register Modules</h2><p><code>RCT_EXPORT_MODULE</code> is in <code>RCTBridgeModule</code> protocol, You can use this macro to export your iOS module. </p>
<blockquote>
<p>Place this macro in your class implementation to automatically register your module with the bridge when it loads. The optional js_name argument. It will be used as the JS module name. If omitted, the JS module name will match the Objective-C class name.</p>
</blockquote>
<p>For example, <code>RCT_EXPORT_MODULE</code> is used in <a target="_blank" rel="noopener" href="https://github.com/react-native-async-storage/async-storage/blob/bfd76c7508bcc35d88f6b6c8d2fd525466f77ba0/ios/RNCAsyncStorage.m#L404">RNCAsyncStorage.m#L404, react-native-async-storage</a>.</p>
<p>This macro will be replaced by the following code in the preprocessor phase when you are compiling a source file. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RCT_EXTERN void RCTRegisterModule(Class); </span><br><span class="line">+ (NSString *)moduleName &#123; return @#js_name; &#125; </span><br><span class="line">+ (void)load &#123; RCTRegisterModule(self); &#125;</span><br></pre></td></tr></table></figure>
<p>In Objc world, <code>load</code> method is invoked whenever a class is added to the Objective-C runtime at the very beginning of app launch. At this time, it invokes <code>RCTRegisterModule</code> function to add the class object into the  <code>RCTModuleClasses</code> array. <code>RCTModuleClasses</code> is an array containing a list of registered classes.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void RCTRegisterModule(Class moduleClass)</span><br><span class="line">&#123;</span><br><span class="line">  static dispatch_once_t onceToken;</span><br><span class="line">  dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">    RCTModuleClasses = [NSMutableArray new];</span><br><span class="line">    RCTModuleClassesSyncQueue =</span><br><span class="line">        dispatch_queue_create(&quot;com.facebook.react.ModuleClassesSyncQueue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  RCTAssert(</span><br><span class="line">      [moduleClass conformsToProtocol:@protocol(RCTBridgeModule)],</span><br><span class="line">      @&quot;%@ does not conform to the RCTBridgeModule protocol&quot;,</span><br><span class="line">      moduleClass);</span><br><span class="line"></span><br><span class="line">  // Register module</span><br><span class="line">  dispatch_barrier_async(RCTModuleClassesSyncQueue, ^&#123;</span><br><span class="line">    [RCTModuleClasses addObject:moduleClass];</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When adding current module class into <code>RCTModuleClasses</code> array,  it uses <code>dispatch_barrier_async</code>  to dispatch this task to a concurrent queue, <code>RCTModuleClassesSyncQueue</code>. Using  <code>dispatch_barrier_async</code> makes sure that<br>one async block executing at a time in <code>RCTModuleClassesSyncQueue</code>. </p>
<p>As we mentioned just now,  <code>RCTModuleClasses</code> is a global array containing a list of registered classes.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Printing description of RCTModuleClasses:</span><br><span class="line">&lt;__NSArrayM 0x7fe4dc5d6bb0&gt;(</span><br><span class="line">....</span><br><span class="line">RNSVGTSpanManager,</span><br><span class="line">RNSVGUseManager,</span><br><span class="line">RCTBaseTextViewManager,</span><br><span class="line">RCTTextViewManager,</span><br><span class="line">RNLinearTextGradientViewManager,</span><br><span class="line">RCTVirtualTextViewManager,</span><br><span class="line">RNVirtualLinearTextGradientViewManager,</span><br><span class="line">RCTAccessibilityManager,</span><br><span class="line">RCTActionSheetManager,</span><br><span class="line">RCTActivityIndicatorViewManager,</span><br><span class="line">RCTAlertManager,</span><br><span class="line">.....</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="Register-and-Initialize-Modules"><a href="#Register-and-Initialize-Modules" class="headerlink" title="Register and Initialize Modules"></a>Register and Initialize Modules</h2><ol>
<li><p><strong>Modules in <code>RCTModuleClasses</code> are registered and initialized in <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L364">start</a>  phase in <code>RCTCxxBridge.mm</code></strong>.  In <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L854">initializeModules:withDispatchGroup:lazilyDiscovered</a>, react native firstly registers all these <code>automatically-exported</code> modules.<a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L854">code here</a>; then store them  into array <code>_moduleClassesByID</code>, a bunch of pointers to <code>Class</code> objects, and <code>_moduleDataByID</code> referring to a bunch of <code>RCTModuleData</code> object. <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L727">code here</a>. The back trace for module registering is as follow: </p>
<p><img src="image-20201001142132537.png" alt="image-20201001142132537"></p>
</li>
<li><p><strong>If the module needs to be set up in <code>main</code> thread. It will be guaranteed running in Main thread</strong>. <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L877">code here</a> and <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L935">here</a>.  It makes sense that <a target="_blank" rel="noopener" href="https://reactnative.dev/docs/native-modules-ios#implementing--requiresmainqueuesetup">react native doc</a> suggests us return <code>NO</code> in the <code>requiresMainQueueSetup</code> method.</p>
</li>
</ol>
<blockquote>
<p>If your module does not require access to UIKit, then you should respond to <code>+ requiresMainQueueSetup</code> with <code>NO</code>.</p>
</blockquote>
<ol start="3">
<li>When the <code>RNBridge</code> is initialized. It inits the <code>RCTCxxBridge</code> and <code>starts</code> it as current bridge.<code>RNBridge</code> in Objc realm basically is a wrapper of <code>RCTCxxBridge.mm</code>. At that time, RN <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L738">registers extra modules</a>. </li>
</ol>
<p>Just as what  <a target="_blank" rel="noopener" href="https://medium.com/u/b25eae7ad28?source=post_page-----9bb82659792c--------------------------------"><em>Lorenzo S.</em></a> shared in this  <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7gm0owyO8HU">talk</a> . The initialization of all modules in <code>RCTCxxBridge</code> start phase slows down its launch time. The more native module you have, the longer time it takes to initialize these modules even you wonâ€™t use them on the first page. </p>
<h2 id="Store-modules"><a href="#Store-modules" class="headerlink" title="Store modules"></a>Store modules</h2><p>In the registration phase, in <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L681"><code>[RCTCXXBridge  _registerModulesForClasses:lazilyDiscovered:]</code></a> , react native stores a list of registered classes into  a dictionary <code>_moduleDataByName</code>. The key is the <code>moduleName</code>, the value is the <code>RCTModuleData</code>. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSMutableDictionary&lt;NSString *, RCTModuleData *&gt; *_moduleDataByName;</span><br></pre></td></tr></table></figure>
<p>Remember, in registering phase, The classes of modules <code>are stored in</code>_moduleClassesByID<code>. While,</code>_moduleDataByID<code>stores</code>RCTModuleData`.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Native modules</span><br><span class="line">NSMutableArray&lt;RCTModuleData *&gt; *_moduleDataByID;</span><br><span class="line">NSMutableArray&lt;Class&gt; *_moduleClassesByID;</span><br></pre></td></tr></table></figure>
<h3 id="RCTModuleData"><a href="#RCTModuleData" class="headerlink" title="RCTModuleData"></a>RCTModuleData</h3><p>Now, you may wondering what is <code>RCTModuleData</code>? While, it is just the data structure to hold data for react native module. </p>
<p><img src="image-20201215174307790.png" alt="image-20201215174307790"></p>
<p><code>RCTBridgeModuleProvider</code> in <code>RCTModuleData</code> is for initializing an <code>instance</code> of <code>RCTBridgeModule</code>. Then, <code>RCTModuleData</code> retain this <code>instance</code>.  In initialization phase, <code>RCTModuleData</code>  creates an instance for the <code>module class</code>  by <code>RCTBridgeModuleProvider</code> . What <code>RCTBridgeModuleProvider</code> does is to provide an instance using<code>[moduleClass new]</code>.  <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/Base/RCTModuleData.mm#L104">Code ref</a>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithModuleClass:(Class)moduleClass</span><br><span class="line">                             bridge:(RCTBridge *)bridge</span><br><span class="line">&#123;</span><br><span class="line">  return [self initWithModuleClass:moduleClass</span><br><span class="line">                    moduleProvider:^id&lt;RCTBridgeModule&gt;&#123; return [moduleClass new]; &#125;</span><br><span class="line">                            bridge:bridge];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Get-Module-by-name-or-class"><a href="#Get-Module-by-name-or-class" class="headerlink" title="Get Module by name or class"></a>Get Module by name or class</h3><p><code>RCTBridge</code> bridge is a simple wrapper for the <code>RCTCxxBridge</code> , to make the methods in <code>RCTCxxBridge.mm</code> available for other Objective-C objects.  You can access to these two methods to get the module from Objective-C objects. </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RCTBridge </span></span><br><span class="line">- (<span class="keyword">id</span>)moduleForName:(<span class="built_in">NSString</span> *)moduleName</span><br><span class="line">- (<span class="keyword">id</span>)moduleForClass:(Class)moduleClass</span><br></pre></td></tr></table></figure>
<p>They will look up the <code>_moduleDataByName</code> dictionary to find out the target  <code>RCTModuleData</code> and get its <code>instance</code>. <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e125f12c01262c11d70c1015139d5f72c5576042/React/CxxBridge/RCTCxxBridge.mm#L529">Source code here</a></p>
<h2 id="Module-related-Class"><a href="#Module-related-Class" class="headerlink" title="Module-related Class"></a>Module-related Class</h2><p>You might be interested in the relationship between these classes.  </p>
<p><img src="module_diagram.png" alt=""></p>
<h2 id="RCTNativeModule-and-ModuleRegistry"><a href="#RCTNativeModule-and-ModuleRegistry" class="headerlink" title="RCTNativeModule and ModuleRegistry"></a><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/master/React/CxxModule/RCTNativeModule.mm">RCTNativeModule</a> and ModuleRegistry</h2><p>In <code>RCTNativeModule.mm</code>, <code>RCTNativeModule</code>, this c++ class inherits from the base class, <code>NativeModule</code>, which holds the info for modules.<br>The constructor method in <code>RCTNativeModule</code> takes in two parameters, <code>RCTBridge</code> object and <code>RCTModuleData</code> object. </p>
<h3 id="Invoke-method-in-RCTNativeModule"><a href="#Invoke-method-in-RCTNativeModule" class="headerlink" title="Invoke method in RCTNativeModule"></a>Invoke method in RCTNativeModule</h3><p>The <code>invoke</code> method in <code>RCTNativeModule</code> </p>
<ol>
<li><p>firstly get the <code>methodName</code> by <code>methodId</code></p>
</li>
<li><p>get the execution queue for current module </p>
</li>
<li><p>construct a block, which calls <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L135"><code>invokeInner</code></a>. <code>invokeInner</code> <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L181">calls</a>  <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L519"><code>invokeWithBridge:module:arguments:</code></a> in the <code>RCTModuleMethod.mm</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">invokeInner</span>(weakBridge, weakModuleData, methodId, std::<span class="built_in">move</span>(params), callId, isSyncModule ? Sync : Async);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="image-20201029152216662.png" alt="image-20201029152216662"></p>
<ol start="4">
<li><p>if current module is executed in <code>JSThread</code>, then block for invoking the method is executed synchronously. But if methods in current module should be executed in other threads, react native will dispatch the previous block into the related queue. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_queue_t</span> queue = m_moduleData.methodQueue;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> isSyncModule = queue == RCTJSThread;</span><br><span class="line"><span class="keyword">if</span> (isSyncModule) &#123;</span><br><span class="line">  <span class="built_in">block</span>();</span><br><span class="line">  BridgeNativeModulePerfLogger::<span class="built_in">syncMethodCallReturnConversionEnd</span>(moduleName, methodName);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (queue) &#123;</span><br><span class="line">  BridgeNativeModulePerfLogger::<span class="built_in">asyncMethodCallDispatch</span>(moduleName, methodName);</span><br><span class="line">  <span class="built_in">dispatch_async</span>(queue, block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="NativeModuleProxy"><a href="#NativeModuleProxy" class="headerlink" title="NativeModuleProxy"></a>NativeModuleProxy</h3><ul>
<li><p>In the Runtime initialization phase, <code>RCTxxBridge.start-&gt;Instance.initializeBridge-&gt;NativeToJSBridge.initializeRuntime-&gt;JSIExecutor.initializeRuntime</code>,</p>
<p>an <code>NativeModuleProxy</code> object is created and set as <code>nativeModuleProxy</code> property to the <code>global</code> object in JavaScript runtime context. </p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">JSIExecutor::initializeRuntime</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> ...</span><br><span class="line">  runtime_-&gt;<span class="built_in">global</span>().<span class="built_in">setProperty</span>(</span><br><span class="line">      *runtime_,</span><br><span class="line">      <span class="string">&quot;nativeModuleProxy&quot;</span>,</span><br><span class="line">      Object::<span class="built_in">createFromHostObject</span>(</span><br><span class="line">          *runtime_, std::make_shared&lt;NativeModuleProxy&gt;(nativeModules_)));</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>In <code>NativeModule.js</code>, JavaScript side can get a bunch of <code>native modules</code> from this <code>nativeModuleProxy</code> property from <code>global</code> object. </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> NativeModules: &#123;[moduleName: string]: $FlowFixMe, ...&#125; = &#123;&#125;;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">global</span>.nativeModuleProxy) &#123;</span><br><span class="line">  NativeModules = <span class="built_in">global</span>.nativeModuleProxy;</span><br></pre></td></tr></table></figure>
<ul>
<li>In the iOS side, the <code>NativeModuleProxy</code> class holds a weak pointer for <code>JSINativeModules</code> , which actually holds a list of registered native modules. </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::weak_ptr&lt;JSINativeModules&gt; weakNativeModules_; </span><br></pre></td></tr></table></figure>
<p><img src="image-20201217183117953.png" alt="image-20201217183117953"></p>
<h2 id="Export-Method"><a href="#Export-Method" class="headerlink" title="Export Method"></a>Export Method</h2><p>The <code>RCT_EXPORT_METHOD</code> macro is used to export method in Objective realm, and will be replaced by the following code</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define RCT_REMAP_METHOD(js_name, method)       \</span><br><span class="line">  _RCT_EXTERN_REMAP_METHOD(js_name, method, NO) \</span><br><span class="line">  </span><br><span class="line">+(const RCTMethodInfo *)RCT_CONCAT(__rct_export__, RCT_CONCAT(js_name, RCT_CONCAT(__LINE__, __COUNTER__))) </span><br><span class="line">  &#123;                                                                                                          </span><br><span class="line">    static RCTMethodInfo config = &#123;#js_name, #method, is_blocking_synchronous_method&#125;;                       </span><br><span class="line">    return &amp;config;                                                                                          </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Basically, what it does is to construct a <code>RCTMethodInfo</code> structure.  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct RCTMethodInfo &#123;</span><br><span class="line">  const char *const jsName;</span><br><span class="line">  const char *const objcName;</span><br><span class="line">  const BOOL isSync;</span><br><span class="line">&#125; RCTMethodInfo;</span><br></pre></td></tr></table></figure>
<p>The  <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/23717e48aff3d7fdaea30c9b8dcdd6cfbb7802d5/React/Base/RCTModuleData.mm#L294">calculateMethods</a>  extracts exported methods and get the <code>IMP</code> of these methods.  <code>IMP</code> actually is a c function which takes in <code>class</code> and <code>selector</code> as its parameters. And then, <code>RCTMethodInfo</code> and <code>moduleClass</code> are used to construct <code>RCTModuleMethod</code>, which confirms to <code>RCTBridgeMethod</code>.</p>
<h3 id="RCTBridgeMethod"><a href="#RCTBridgeMethod" class="headerlink" title="RCTBridgeMethod"></a>RCTBridgeMethod</h3><p>The <code>RCTModuleData</code> also contains information about exported methods.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns the module methods. Note that this will gather the methods the first</span><br><span class="line"> * time it is called and then memoize the results.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy, readonly) NSArray&lt;id&lt;RCTBridgeMethod&gt;&gt; *methods;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Returns a map of the module methods. Note that this will gather the methods the first</span><br><span class="line"> * time it is called and then memoize the results.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy, readonly) NSDictionary&lt;NSString *, id&lt;RCTBridgeMethod&gt;&gt; *methodsByName;</span><br></pre></td></tr></table></figure>
<p>The <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/23717e48aff3d7fdaea30c9b8dcdd6cfbb7802d5/React/Base/RCTModuleData.mm#L373">getter methods</a> for these two will generate a list of <code>RCTBridgeMethod</code> objects. <code>RCTBridgeMethod</code> is a protocol. Any class confirms to this protocol has to implement <code>JSMethodName</code>,  <code>functionType</code> and <code>invokeWithBridge: module:arguments:</code> function. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@protocol RCTBridgeMethod &lt;NSObject&gt;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, readonly) const char *JSMethodName;</span><br><span class="line">@property (nonatomic, readonly) RCTFunctionType functionType;</span><br><span class="line"></span><br><span class="line">- (id)invokeWithBridge:(RCTBridge *)bridge module:(id)module arguments:(NSArray *)arguments;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>So when react native triggers these two getter method? Well, in the <code>RCTUIManager</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RCT_EXPORT_METHOD(dispatchViewManagerCommand</span><br><span class="line">                  : (nonnull NSNumber *)reactTag commandID</span><br><span class="line">                  : (id /*(NSString or NSNumber) */)commandID commandArgs</span><br><span class="line">                  : (NSArray&lt;id&gt; *)commandArgs)</span><br></pre></td></tr></table></figure>
<p>Beside, <code>RCTModuleData</code> also sets up and holds the thread <code>methodQueue</code> for the native module.  This <code>dispatch_queue_t</code> object is also retained in <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/e54ead6556f813fc622fd5e1f27ab2b41fa4f213/React/Base/RCTBridgeModule.h#L155">RCTBridgeModule.h</a>, which is used to call all exported methods.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setUpMethodQueue</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (_instance &amp;&amp; !_methodQueue &amp;&amp; _bridge.valid) &#123;</span><br><span class="line">    RCT_PROFILE_BEGIN_EVENT(RCTProfileTagAlways, <span class="string">@&quot;[RCTModuleData setUpMethodQueue]&quot;</span>, <span class="literal">nil</span>);</span><br><span class="line">    <span class="built_in">BOOL</span> implementsMethodQueue = [_instance respondsToSelector:<span class="keyword">@selector</span>(methodQueue)];</span><br><span class="line">    <span class="keyword">if</span> (implementsMethodQueue &amp;&amp; _bridge.valid) &#123;</span><br><span class="line">      _methodQueue = _instance.methodQueue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!_methodQueue &amp;&amp; _bridge.valid) &#123;</span><br><span class="line">      <span class="comment">// Create new queue (store queueName, as it isn&#x27;t retained by dispatch_queue)</span></span><br><span class="line">      _queueName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;com.facebook.react.%@Queue&quot;</span>, <span class="keyword">self</span>.name];</span><br><span class="line">      _methodQueue = dispatch_queue_create(_queueName.UTF8String, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// assign it to the module</span></span><br><span class="line">      <span class="keyword">if</span> (implementsMethodQueue) &#123;</span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">          [(<span class="keyword">id</span>)_instance setValue:_methodQueue forKey:<span class="string">@&quot;methodQueue&quot;</span>];</span><br><span class="line">        &#125; <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">          RCTLogError(</span><br><span class="line">              <span class="string">@&quot;%@ is returning nil for its methodQueue, which is not &quot;</span></span><br><span class="line">               <span class="string">&quot;permitted. You must either return a pre-initialized &quot;</span></span><br><span class="line">               <span class="string">&quot;queue, or @synthesize the methodQueue to let the bridge &quot;</span></span><br><span class="line">               <span class="string">&quot;create a queue for you.&quot;</span>,</span><br><span class="line">              <span class="keyword">self</span>.name);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    RCT_PROFILE_END_EVENT(RCTProfileTagAlways, <span class="string">@&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="How-does-JS-invoke-a-method-in-Native"><a href="#How-does-JS-invoke-a-method-in-Native" class="headerlink" title="How does JS invoke a method in Native?"></a>How does JS invoke a method in Native?</h2><p>I set a breakpoint at   <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L519"><code>[RCTModuleMethod invokeWithBridge:module:arguments:]</code></a>.</p>
<p><img src="image-20201217171417579.png" alt="image-20201217171417579"></p>
<ol>
<li>in initialization phase, <code>nativeFlushQueueImmediate</code> property is set in the global object of the JavaScript execution context.. <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/jsiexecutor/jsireact/JSIExecutor.cpp#L90">code reference here</a>. <code>global.nativeFlushQueueImmediate(queue)</code> is called in <code>enqueueNativeCall</code> from the Javascript side. <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/Libraries/BatchedBridge/MessageQueue.js#L318">code ref.</a>  Before calling, it makes sure the last Flush is 5 milliseconds ago;  then <code>nativeFlushQueueImmediate</code> is triggered.  </li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (</span><br><span class="line">     <span class="built_in">global</span>.nativeFlushQueueImmediate &amp;&amp;</span><br><span class="line">     now - <span class="built_in">this</span>._lastFlush &gt;= MIN_TIME_BETWEEN_FLUSHES_MS</span><br><span class="line">   ) &#123;</span><br><span class="line">     <span class="keyword">const</span> queue = <span class="built_in">this</span>._queue;</span><br><span class="line">     <span class="built_in">this</span>._queue = [[], [], [], <span class="built_in">this</span>._callID];</span><br><span class="line">     <span class="built_in">this</span>._lastFlush = now;</span><br><span class="line">     <span class="comment">// ðŸŒŸ</span></span><br><span class="line">     <span class="built_in">global</span>.nativeFlushQueueImmediate(queue);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/jsi/JSCRuntime.cpp#L1151"><code>call</code> function in JSCRuntime</a> is invoked when there is a method call from JavaScrip side, then the <code>host function</code> is triggered. In this case, the host function is <code>nativeFlushQueueImmediate</code> in the C++ realm.</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">JSValueRef <span class="function"><span class="title">call</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        JSContextRef ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">        JSObjectRef <span class="keyword">function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        JSObjectRef thisObject,</span></span></span><br><span class="line"><span class="params"><span class="function">        size_t argumentCount,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> JSValueRef <span class="built_in">arguments</span>[],</span></span></span><br><span class="line"><span class="params"><span class="function">        JSValueRef *exception</span>)</span> &#123;</span><br><span class="line">  HostFunctionMetadata *metadata =</span><br><span class="line">          static_cast&lt;HostFunctionMetadata *&gt;(JSObjectGetPrivate(<span class="function"><span class="keyword">function</span>))</span>;</span><br><span class="line">  JSCRuntime &amp;rt = *(metadata-&gt;runtime);</span><br><span class="line">  ...</span><br><span class="line">     <span class="comment">// ðŸŒŸðŸŒŸ</span></span><br><span class="line">     metadata-&gt;hostFunction_(rt, thisVal, args, argumentCount));</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>See the following C++ lambda is used to create the host function <code>nativeFlushQueueImmediate</code>. In side this  C++ lambda,  we can see it calls <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/jsiexecutor/jsireact/JSIExecutor.cpp#L106">callNativeModules</a>.</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">runtime_-&gt;<span class="built_in">global</span>().<span class="built_in">setProperty</span>(</span><br><span class="line">     *runtime_,</span><br><span class="line">     <span class="string">&quot;nativeFlushQueueImmediate&quot;</span>,</span><br><span class="line">     Function::<span class="built_in">createFromHostFunction</span>(</span><br><span class="line">         *runtime_,</span><br><span class="line">         PropNameID::forAscii(*runtime_, <span class="string">&quot;nativeFlushQueueImmediate&quot;</span>),</span><br><span class="line">         <span class="number">1</span>,</span><br><span class="line">         [<span class="keyword">this</span>](</span><br><span class="line">             jsi::Runtime &amp;,</span><br><span class="line">             <span class="keyword">const</span> jsi::Value &amp;,</span><br><span class="line">             <span class="keyword">const</span> jsi::Value *args,</span><br><span class="line">             <span class="keyword">size_t</span> count) &#123;</span><br><span class="line">           <span class="keyword">if</span> (count != <span class="number">1</span>) &#123;</span><br><span class="line">             <span class="keyword">throw</span> std::<span class="built_in">invalid_argument</span>(</span><br><span class="line">                 <span class="string">&quot;nativeFlushQueueImmediate arg count must be 1&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="built_in">callNativeModules</span>(args[<span class="number">0</span>], <span class="literal">false</span>);</span><br><span class="line">           <span class="keyword">return</span> Value::<span class="built_in">undefined</span>();</span><br><span class="line">         &#125;</span><br><span class="line">     )</span><br><span class="line"> );</span><br></pre></td></tr></table></figure>
<p>Then <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/jsiexecutor/jsireact/JSIExecutor.cpp#L390"> <code>callNativeModules</code> in <code>JSToNativeBridge</code></a> is invoked.</p>
<ol start="4">
<li>The <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/cxxreact/NativeToJsBridge.cpp#L54">callNativeModules in <code>JSToNativeBridge</code></a> firstly parses the <code>JSON</code> data to get the <code>moduleIds</code>, <code>methodIds</code> and <code>params</code>, etc.  <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/cxxreact/MethodCall.cpp#L38">source code here</a>.  After constructing <code>MethodCall</code> structure, which holds <code>moduleId</code>, <code>methodId</code>, <code>arguments</code>, <code>callId</code>, <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/ReactCommon/cxxreact/ModuleRegistry.cpp#L220"><code>callNativeModules</code> in <code>ModuleRegistry.cpp</code></a>  is called.</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// This is always populated</span></span><br><span class="line">std::vector&lt;std::unique_ptr&lt;NativeModule&gt;&gt; modules_;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ModuleRegistry::callNativeMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">unsigned</span> <span class="keyword">int</span> moduleId,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">unsigned</span> <span class="keyword">int</span> methodId,</span></span></span><br><span class="line"><span class="params"><span class="function">  folly::dynamic &amp;&amp;params,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">int</span> callId)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (moduleId &gt;= modules_.<span class="built_in">size</span>()) &#123;</span><br><span class="line">  <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(folly::to&lt;std::string&gt;(</span><br><span class="line">      <span class="string">&quot;moduleId &quot;</span>, moduleId, <span class="string">&quot; out of range [0..&quot;</span>, modules_.<span class="built_in">size</span>(), <span class="string">&quot;)&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line">modules_[moduleId]-&gt;<span class="built_in">invoke</span>(methodId, std::<span class="built_in">move</span>(params), callId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>moduleId</code> is used to look up the <code>NativeModule</code> object in a list of modules.  <code>NativeModule</code> list is set up in <code>CxxBridge</code> initialization phases, which basically is a vector holding module information in C++ realm, transformed from <code>_moduleDataByID</code> array in Objc realm. As we know <code>_moduleDataByID</code> is a list of  <code>RCTModuleData</code> holding registered <code>RCTBridgeModule</code> and its instance. </p>
<ol start="5">
<li><p>It goes to <code>invoke</code> in the <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/CxxModule/RCTNativeModule.mm#L106"><code>RCTNativeModule.mm</code></a>, which has module info in its private variable <code>RCTModuleData</code> object. </p>
</li>
<li><p>The<a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L74"><code>invoke</code></a> function in the <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/CxxModule/RCTNativeModule.mm#L106"><code>RCTNativeModule.mm</code></a> calls <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L135"><code>invokeInner</code></a>. Inside <code>invokeInner</code>, it get the <code>RCTBridgeMethod</code> object from <code>RCTModuleData</code> object using <code>methodId</code> . <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/CxxModule/RCTNativeModule.mm#L155">code</a></p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&lt;RCTBridgeMethod&gt; method = moduleData.methods[methodId]</span><br></pre></td></tr></table></figure>
<p>Then, it <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/306a8adade432ae5c12f0a13130c4e599d64c642/React/CxxModule/RCTNativeModule.mm#L181">calls</a>  <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L519"><code>invokeWithBridge:module:arguments:</code></a> in the <code>RCTModuleMethod.mm</code>. </p>
<p><img src="image-20201029152216662.png" alt="image-20201029152216662"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id result = [method invokeWithBridge:bridge <span class="keyword">module</span>:moduleData.instance arguments:objcParams];</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/CxxModule/RCTNativeModule.mm#L181">code ref</a></p>
<p><img src="image-20201029162107074.png" alt="image-20201029162107074" style="zoom:50%;" /></p>
<ol start="7">
<li>The  <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L519"><code>invokeWithBridge:module:arguments:</code></a>  uses <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L566"> NSInvocation </a> to send message to the related <code>module</code> object. </li>
</ol>
<blockquote>
<p> An <code>NSInvocation</code> object contains all the elements of an Objective-C message: a target, a selector, arguments, and the return value.</p>
</blockquote>
<p>â€‹<br>7.1.  <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/17a8737ecb68f61a14f54bf0e2efeb618f97d326/React/Base/RCTModuleMethod.mm#L204">parse MethodSignature</a> to init <code>NSInvocation</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_selector = NSSelectorFromString(RCTParseMethodSignature(_methodInfo-&gt;objcName, &amp;arguments));</span><br><span class="line">....  </span><br><span class="line">NSInvocation *invocation = [NSInvocation invocationWithMethodSignature:methodSignature];</span><br><span class="line">...</span><br><span class="line">// set  selector  </span><br><span class="line">invocation.selector = _selector;  </span><br></pre></td></tr></table></figure>
<p>7.2, trigger the method in the module  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[_invocation invokeWithTarget:module];</span><br></pre></td></tr></table></figure>
<p>In a nutshell,  when JavaScript side calls a method in a specific native module, the indices of the module and method are passed to Objc through JSCRuntime. These information is serialized as JSON object. By looking up the table which holds the information about registered modules and methods, React Native can invoke the specific method in a specific module in the Objective-C realm.  There are some <a target="_blank" rel="noopener" href="https://github.com/react-native-community/discussions-and-proposals/blob/master/proposals/0002-Turbo-Modules.md#motivation">restrictions</a> in this workflow. </p>
<p><img src="image-20201001143632128.png" alt="image-20201001143632128"></p>
<blockquote>
<ol>
<li>Native Modules are specified in <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/1e8f3b11027fe0a7514b4fc97d0798d3c64bc895/local-cli/link/__fixtures__/android/0.20/MainActivity.java#L37">a package</a> and are eagerly initialized. The startup time of React Native increases with the number of Native Modules, even if some of those Native Modules are never used. </li>
<li>There is no simple way to check if the Native Modules that JavaScript calls are actually included in the native app. With over the air updates, there is no easy way to check if a newer version of JavaScript calls the right method with the correct set of arguments in Native Module.</li>
<li>Native Modules are always singleton and their lifecycle is typically tied to the lifetime of the bridge. This issue is compounded in brownfield apps where the React Native bridge may start and shut down multiple times.</li>
<li>During the startup process, Native Modules are typically specified in <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/b938cd524a20c239a5d67e4a1150cd19e00e45ba/ReactAndroid/src/main/java/com/facebook/react/CompositeReactPackage.java">multiple packages</a>. We then <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/407e033b34b6afa0ea96ed72f16cd164d572e911/ReactAndroid/src/main/java/com/facebook/react/ReactInstanceManager.java#L1132">iterate</a> over the list <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/617e25d9b5cb10cfc6842eca62ff22d39eefcf7b/ReactAndroid/src/main/java/com/facebook/react/bridge/NativeModuleRegistry.java#L46">multiple times</a> before we finally give the bridge a <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/CatalystInstanceImpl.java#L124">list of Native Modules</a>. This does not need to happen at runtime.</li>
<li>The actual methods and constants of a Native Module are <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/master/ReactCommon/cxxreact/ModuleRegistry.cpp#L81">computed during runtime</a> using <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/JavaModuleWrapper.java#L75">reflection</a>. </li>
</ol>
</blockquote>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#Dive into React Native" >
    <span class="tag-code">Dive into React Native</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2020/08/18/20200817-ios-main-in-assembly/">
        <span class="nav-arrow">â† </span>
        
          iOS main in Assembly
        
      </a>
    
    
      <a class="nav-right" href="/2020/12/24/20201224-How-Image-Loader-and-Cache-work-in-React-Native/">
        
          How Image Loader and Cache work in React Native
        
        <span class="nav-arrow"> â†’</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- æ‰“èµ START -->
  
    <!-- äºŒç»´ç  START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">scan qr code and share this article</p>
      </div>
    
    <!-- äºŒç»´ç  END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo="null"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Export-and-Register-Modules"><span class="toc-nav-text">Export and Register Modules</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Register-and-Initialize-Modules"><span class="toc-nav-text">Register and Initialize Modules</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Store-modules"><span class="toc-nav-text">Store modules</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#RCTModuleData"><span class="toc-nav-text">RCTModuleData</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Get-Module-by-name-or-class"><span class="toc-nav-text">Get Module by name or class</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Module-related-Class"><span class="toc-nav-text">Module-related Class</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#RCTNativeModule-and-ModuleRegistry"><span class="toc-nav-text">RCTNativeModule and ModuleRegistry</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Invoke-method-in-RCTNativeModule"><span class="toc-nav-text">Invoke method in RCTNativeModule</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#NativeModuleProxy"><span class="toc-nav-text">NativeModuleProxy</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Export-Method"><span class="toc-nav-text">Export Method</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#RCTBridgeMethod"><span class="toc-nav-text">RCTBridgeMethod</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#How-does-JS-invoke-a-method-in-Native"><span class="toc-nav-text">How does JS invoke a method in Native?</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://suelan.github.io/2020/12/23/20201223-what-is-behind-react-native-module/';
    var banner = 'undefined'
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2021 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>