<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="RY&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" type="image/ico" href="[object Object]"/>
  
  <title>
    
      Understand onViewableItemsChanged in FlatList | RY &#39;s Blog
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 5.4.2"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>RY 's Blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/series/" class="item-link">Series</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/series/" class="menu-link">Series</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>Understand onViewableItemsChanged in FlatList</h2>
  <p class="post-date">2020-01-21</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>If you want to get viewable items in the [FlatList], you had better take a look at the <code>onViewableItemsChanged</code> prop. For example, suppose you have a video list, and you want automatically play the video when the video is appearing on the screen for a few seconds. In iOS, there is <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/uicollectionview/1618056-visiblecells">visibleCells</a> in <code>UITableView</code> to achieve this. In React Native, I am glad to tell you that <code>FlatList</code> has a more powerful property, <code>onViewableItemsChanged</code>. <code>This article would help you better understand how to use the</code>onViewableItemsChanged` prop in the [FlatList], and how it works under the hood.</p>
<h2 id="What-is-onViewableItemsChanged"><a href="#What-is-onViewableItemsChanged" class="headerlink" title="What is onViewableItemsChanged"></a>What is onViewableItemsChanged</h2><p><code>onViewableItemsChanged</code> is a prop in <a target="_blank" rel="noopener" href="https://facebook.github.io/react-native/docs/virtualizedlist#onviewableitemschanged">VirtualizedList</a> and <a target="_blank" rel="noopener" href="https://facebook.github.io/react-native/docs/flatlist#onviewableitemschanged">FlatList</a>. When you scroll a FlatList, the items showing on the FlatList change. Then, this function is called, telling you what current <code>viewableItems</code> are and what <code>changed</code> items are. </p>
<p>This function should be used together with <a target="_blank" rel="noopener" href="https://facebook.github.io/react-native/docs/virtualizedlist#viewabilityconfig">viewabilityConfig</a>. A specific <code>onViewableItemsChanged</code> will be called when its corresponding <code>ViewabilityConfig</code>‘s conditions are met.</p>
<p>Here is <a target="_blank" rel="noopener" href="https://facebook.github.io/react-native/docs/flatlist#viewabilityconfig">ViewabilityConfig</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type ViewabilityConfig = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Minimum amount of time (in milliseconds) that an item must be physically viewable before the</span></span><br><span class="line"><span class="comment">   * viewability callback will be fired. A high number means that scrolling through content without</span></span><br><span class="line"><span class="comment">   * stopping will not mark the content as viewable.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  minimumViewTime?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Percent of viewport that must be covered for a partially occluded item to count as</span></span><br><span class="line"><span class="comment">   * &quot;viewable&quot;, 0-100. Fully visible items are always considered viewable. A value of 0 means</span></span><br><span class="line"><span class="comment">   * that a single pixel in the viewport makes the item viewable, and a value of 100 means that</span></span><br><span class="line"><span class="comment">   * an item must be either entirely visible or cover the entire viewport to count as viewable.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  viewAreaCoveragePercentThreshold?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Similar to `viewAreaPercentThreshold`, but considers the percent of the item that is visible,</span></span><br><span class="line"><span class="comment">   * rather than the fraction of the viewable area it covers.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  itemVisiblePercentThreshold?: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Nothing is considered viewable until the user scrolls or `recordInteraction` is called after</span></span><br><span class="line"><span class="comment">   * render.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  waitForInteraction?: boolean,</span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure><br>Here is the type of <code>onViewableItemsChanged</code> function:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called when the viewability of rows changes, as defined by the</span></span><br><span class="line"><span class="comment">   * `viewabilityConfig` prop.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onViewableItemsChanged?: ?<span class="function">(<span class="params">info: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    viewableItems: <span class="built_in">Array</span>&lt;ViewToken&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    changed: <span class="built_in">Array</span>&lt;ViewToken&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    ...</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span>) =&gt;</span> <span class="keyword">void</span>,</span><br><span class="line">  </span><br><span class="line"><span class="keyword">export</span> type ViewToken = &#123;</span><br><span class="line">  <span class="attr">item</span>: any,</span><br><span class="line">  <span class="comment">// The key of this item</span></span><br><span class="line">  <span class="attr">key</span>: string,</span><br><span class="line">  <span class="attr">index</span>: ?number,</span><br><span class="line">  <span class="comment">// indicated whether this item is viewable or not</span></span><br><span class="line">  <span class="attr">isViewable</span>: boolean,</span><br><span class="line">  section?: any,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="How-to-use-it"><a href="#How-to-use-it" class="headerlink" title="How to use it"></a>How to use it</h2><p>Let’s look at two simple example.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">viewabilityConfig = &#123;</span><br><span class="line">  <span class="attr">waitForInteraction</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// At least one of the viewAreaCoveragePercentThreshold or itemVisiblePercentThreshold is required.</span></span><br><span class="line">  <span class="attr">viewAreaCoveragePercentThreshold</span>: <span class="number">95</span>,</span><br><span class="line">  <span class="attr">itemVisiblePercentThreshold</span>: <span class="number">75</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onViewableItemsChanged = <span class="function">(<span class="params">&#123;viewableItems, changed&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Visible items are&quot;</span>, viewableItems);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Changed in this iteration&quot;</span>, changed);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">FlatList</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">viewabilityConfig</span>=<span class="string">&#123;this.viewabilityConfig&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">onViewableItemsChanged</span>=<span class="string">&#123;this.onViewableItemsChanged&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">data</span>=<span class="string">&#123;this._items&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">renderItem</span>=<span class="string">&#123;this._renderItem&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">keyExtractor</span>=<span class="string">&#123;item</span> =&gt;</span> item.id&#125;</span></span><br><span class="line"><span class="xml">    /&gt;</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Besides, supposed you have to implement different logic for items with 60% viewable region and those with 75% viewable region. You can use <code>viewabilityConfigCallbackPairs</code>, which contains an list of key/value objects, which define different <code>viewability</code> configurations and <code>onViewableItemsChanged</code> callbacks.  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;FlatList</span><br><span class="line">    data=&#123;<span class="built_in">this</span>._items&#125;</span><br><span class="line">    renderItem=&#123;<span class="built_in">this</span>._renderItem&#125;</span><br><span class="line">    keyExtractor=&#123;<span class="function">(<span class="params">item</span>) =&gt;</span> item.id &#125;</span><br><span class="line">    viewabilityConfigCallbackPairs=&#123;<span class="built_in">this</span>._viewabilityConfigCallbackPairs&#125;</span><br><span class="line">/&gt;</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>._viewabilityConfigCallbackPairs = [&#123;</span><br><span class="line">    <span class="attr">viewabilityConfig</span>: &#123;</span><br><span class="line">      <span class="attr">minimumViewTime</span>: <span class="number">600</span>,</span><br><span class="line">      <span class="attr">itemVisiblePercentThreshold</span>: <span class="number">60</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onViewableItemsChanged</span>: <span class="built_in">this</span>.handleItemsPartiallyVisible60</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">viewabilityConfig</span>: &#123;</span><br><span class="line">      <span class="attr">minimumViewTime</span>: <span class="number">700</span>,</span><br><span class="line">      <span class="attr">itemVisiblePercentThreshold</span>: <span class="number">75</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onViewableItemsChanged</span>: <span class="built_in">this</span>.handleItemsPartiallyVisible75</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h2 id="How-does-onViewableItemsChanged-works"><a href="#How-does-onViewableItemsChanged-works" class="headerlink" title="How does onViewableItemsChanged works"></a>How does onViewableItemsChanged works</h2><h3 id="Viewable-Region"><a href="#Viewable-Region" class="headerlink" title="Viewable Region"></a>Viewable Region</h3><p>  The layout and viewable region information for VirtualizedList is stored in <code>_scrollMetrics</code> object. Through the <code>nativeEvent</code> in <code>onScroll</code> callback, VirtualizedList gets these layout information.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> timestamp = e.timeStamp;</span><br><span class="line"><span class="keyword">let</span> visibleLength = <span class="built_in">this</span>._selectLength(e.nativeEvent.layoutMeasurement);</span><br><span class="line"><span class="keyword">let</span> contentLength = <span class="built_in">this</span>._selectLength(e.nativeEvent.contentSize);</span><br><span class="line"><span class="keyword">let</span> offset = <span class="built_in">this</span>._selectOffset(e.nativeEvent.contentOffset);</span><br><span class="line"><span class="keyword">let</span> dOffset = offset - <span class="built_in">this</span>._scrollMetrics.offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... more code here</span></span><br><span class="line"></span><br><span class="line"> <span class="built_in">this</span>._scrollMetrics = &#123;</span><br><span class="line">      contentLength,</span><br><span class="line">      dt,</span><br><span class="line">      dOffset,</span><br><span class="line">      offset,</span><br><span class="line">      timestamp,</span><br><span class="line">      velocity,</span><br><span class="line">      visibleLength,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>If it is a vertical VirtualizedList, the  <code>layout.layoutMeasurement.height</code> in the <code>nativeEvent</code> is assigned to <code>visibleLength</code>; which is the height of viewable region here.  Also, in a vertical VirtualizedList, the  <code>layout.layoutMeasurement.height</code>  is equal to viewportHeight.</p>
<p><img src="/img/9af4f3b0-fe64-4a98-b94e-d456f65ae7cc/5d152b82.png" alt="5d152b82.png"></p>
<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p><img src="/img/9af4f3b0-fe64-4a98-b94e-d456f65ae7cc/a0336b02.png" alt="a0336b02.png"></p>
<h4 id="Different-viewabilityConfig-in-one-VirtualizedList"><a href="#Different-viewabilityConfig-in-one-VirtualizedList" class="headerlink" title="Different viewabilityConfig  in one VirtualizedList"></a>Different <code>viewabilityConfig</code>  in one <code>VirtualizedList</code></h4><p><code>_viewabilityTuples</code> is an array inside <code>VirtualizedList</code> to store <code>ViewabilityHelper/onViewableItemsChanged</code> pairs. This array is initialized in the <code>constructor</code> function.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_viewabilityTuples: <span class="built_in">Array</span>&lt;ViewabilityHelperCallbackTuple&gt; = [];</span><br><span class="line"></span><br><span class="line">type ViewabilityHelperCallbackTuple = &#123;</span><br><span class="line">  <span class="attr">viewabilityHelper</span>: ViewabilityHelper,</span><br><span class="line">  <span class="attr">onViewableItemsChanged</span>: <span class="function">(<span class="params">info: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    viewableItems: <span class="built_in">Array</span>&lt;ViewToken&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    changed: <span class="built_in">Array</span>&lt;ViewToken&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    ...</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span>) =&gt;</span> <span class="keyword">void</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If you define <a target="_blank" rel="noopener" href="https://facebook.github.io/react-native/docs/flatlist#viewabilityconfigcallbackpairs">viewabilityConfigCallbackPairs</a>,  each <code>viewabilityConfig</code> will be used to initialize a different <code>ViewabilityHelper</code> object.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/VirtualizedList.js#L743">ref code</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.props.viewabilityConfigCallbackPairs) &#123;</span><br><span class="line">     <span class="built_in">this</span>._viewabilityTuples = <span class="built_in">this</span>.props.viewabilityConfigCallbackPairs.map(</span><br><span class="line">       <span class="function"><span class="params">pair</span> =&gt;</span> (&#123;</span><br><span class="line">         <span class="attr">viewabilityHelper</span>: <span class="keyword">new</span> ViewabilityHelper(pair.viewabilityConfig),</span><br><span class="line">         <span class="attr">onViewableItemsChanged</span>: pair.onViewableItemsChanged,</span><br><span class="line">       &#125;),</span><br><span class="line">     );</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.props.onViewableItemsChanged) &#123;</span><br><span class="line">     <span class="built_in">this</span>._viewabilityTuples.push(&#123;</span><br><span class="line">       <span class="attr">viewabilityHelper</span>: <span class="keyword">new</span> ViewabilityHelper(<span class="built_in">this</span>.props.viewabilityConfig),</span><br><span class="line">       <span class="attr">onViewableItemsChanged</span>: <span class="built_in">this</span>.props.onViewableItemsChanged,</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>ViewabilityHelper</code> is <code>a utility class for calculating viewable items based on the viewabilityConfig and metrics, like the scroll position and layout.</code></p>
<p>As I mentioned before, in a <code>VirtualizedList</code> could has several <code>ViewabilityHelper</code> objects in <code>_viewabilityTuples</code>, containing different <code>viewabilityConfig</code> to handle different viewability conditions. Let’s take a look at some important props in <code>ViewabilityHelper</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewabilityHelper</span> </span>&#123;</span><br><span class="line">  <span class="attr">_config</span>: ViewabilityConfig;</span><br><span class="line">  _hasInteracted: boolean = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">/* A set of `timeoutID`, used for memory management */</span></span><br><span class="line">  _timers: <span class="built_in">Set</span>&lt;number&gt; = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  <span class="comment">// Indexes of the viewable items</span></span><br><span class="line">  _viewableIndices: <span class="built_in">Array</span>&lt;number&gt; = [];</span><br><span class="line">  <span class="comment">// A map for viewable items</span></span><br><span class="line">  _viewableItems: <span class="built_in">Map</span>&lt;string, ViewToken&gt; = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Items’-layout"><a href="#Items’-layout" class="headerlink" title="Items’ layout"></a>Items’ layout</h4><p>In the overview graph, you can see a func <code>_updateViewableItems</code> called in many scenarios. For example, it is called in <code>onScroll</code> callback. Then, It calls <code>viewabilityHelper.onUpdate</code> to find out the viewable items, which appear in the viewport for VirtualizedList.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">_updateViewableItems</span>(<span class="params">data: any</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;getItemCount&#125; = <span class="built_in">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>._viewabilityTuples.forEach(<span class="function"><span class="params">tuple</span> =&gt;</span> &#123;</span><br><span class="line">      tuple.viewabilityHelper.onUpdate(</span><br><span class="line">        getItemCount(data),</span><br><span class="line">        <span class="comment">// contentOffset of the list </span></span><br><span class="line">        <span class="built_in">this</span>._scrollMetrics.offset,</span><br><span class="line">        <span class="comment">// 🌟 viewportHeight </span></span><br><span class="line">        <span class="built_in">this</span>._scrollMetrics.visibleLength, </span><br><span class="line">        <span class="built_in">this</span>._getFrameMetrics,</span><br><span class="line">        <span class="built_in">this</span>._createViewToken,</span><br><span class="line">        tuple.onViewableItemsChanged,</span><br><span class="line">        <span class="built_in">this</span>.state,</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>this._scrollMetrics.visibleLength</code> is used as <code>viewportHeight</code></li>
<li><code>this._createViewToken</code> is used to construct a <code>ViewToken</code> object, which contains <code>item</code> data, <code>index</code>, <code>key</code> and <code>isViewable</code> flag of the <code>item</code>. </li>
<li><a href="1864">this._getFrameMetrics</a> is a function to get layout information of the item cell by index. The item layout is from <code>getItemLayout</code> prop of  <code>VirtualizedList</code> or <code>this._frames</code> map. <code>this._frames</code> stores the itemKey/itemLayout pairs.  </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// this._frames stores the item cell layout info</span></span><br><span class="line">&#123; [cellKey]: &#123;</span><br><span class="line">      <span class="comment">// offset of the item cell</span></span><br><span class="line">      <span class="attr">offset</span>: number, </span><br><span class="line">      <span class="comment">// length of the item cell. width or height determined by the direction of the VirtualizedList</span></span><br><span class="line">      <span class="attr">length</span>: number, </span><br><span class="line">      <span class="attr">index</span>: number,</span><br><span class="line">      <span class="attr">inLayout</span>: boolean,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>By <code>this.state</code>, we know the range of the rendered items by  <code>first</code> and <code>last</code> value. <code>VirtualizedList</code> updates these two values when the rendered items are changed.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type State = &#123;</span><br><span class="line">  <span class="comment">// The range of the rendered items, </span></span><br><span class="line">  <span class="comment">// used for the optimization to reduce the scan size</span></span><br><span class="line">  <span class="attr">first</span>: number,</span><br><span class="line">  <span class="attr">last</span>: number,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="How-to-find-out-viewable-items"><a href="#How-to-find-out-viewable-items" class="headerlink" title="How to find out viewable items"></a>How to find out viewable items</h3><p>In <code>onUpdate</code> method, it calls <code>computeViewableItems</code> to get <code>viewableIndices</code>. <code>viewableIndices</code> is an array of indexes of the viewable items.  So, how does <code>computeViewableItems</code>  work?  </p>
<h4 id="How-to-get-the-indexes-of-viewable-items"><a href="#How-to-get-the-indexes-of-viewable-items" class="headerlink" title="How to get the indexes of viewable items"></a>How to get the indexes of viewable items</h4><p>In <code>computeViewableItems</code> in the <code>ViewabilityHelper</code> class, it iterates items from <code>$&#123;first&#125;</code> to <code>$&#123;last&#125;</code>. If an item is viewable, it will be stored in an array named <code>viewableIndices</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> idx = first; idx &lt;= last; idx++) &#123;</span><br><span class="line">    <span class="keyword">const</span> metrics = getFrameMetrics(idx);</span><br><span class="line">    <span class="keyword">if</span> (!metrics) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The top of current item cell, relative to the screen coordinate</span></span><br><span class="line">    <span class="keyword">const</span> top = metrics.offset - scrollOffset;</span><br><span class="line">    <span class="comment">// The bottom of current item cell, relative to the screen coordinate</span></span><br><span class="line">    <span class="keyword">const</span> bottom = top + metrics.length;</span><br><span class="line">    <span class="keyword">if</span> (top &lt; viewportHeight &amp;&amp; bottom &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      firstVisible = idx;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        _isViewable(</span><br><span class="line">          viewAreaMode,</span><br><span class="line">          viewablePercentThreshold,</span><br><span class="line">          top,</span><br><span class="line">          bottom,</span><br><span class="line">          viewportHeight,</span><br><span class="line">          metrics.length,</span><br><span class="line">        )</span><br><span class="line">      ) &#123;</span><br><span class="line">        viewableIndices.push(idx);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstVisible &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> viewableIndices;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>From the code, we can see the <code>top</code> and <code>bottom</code> value is related to the screen coordinate. I drew a graph to show the relationship between <code>metrics.offset</code>, <code>scrollOffset</code>, <code>metrics.length</code> , <code>top</code> and <code>bottom</code>, to help you better understand the above code.</p>
<p><img src="/img/9af4f3b0-fe64-4a98-b94e-d456f65ae7cc/3252d60e.png" alt="layout.png"></p>
<h3 id="What-kind-of-item-is-viewable"><a href="#What-kind-of-item-is-viewable" class="headerlink" title="What kind of item is viewable"></a>What kind of item is viewable</h3><p> An item is said to be viewable when it meets the following conditions<br> for longer than <code>$&#123;minimumViewTime&#125;</code> milliseconds (after an interaction if <code>waitForInteraction</code><br> is true):</p>
<ol>
<li><p>the fraction of the item visible in the view area &gt;= <code>itemVisiblePercentThreshold</code>.<br>When it comes to the fraction of the item visible in the view area, we need to care about<br>cases shown in the following graph. RN use <code>Math.min(bottom, viewportHeight) - Math.max(top, 0)</code> to calculate the viewable length. </p>
<p><img src="viewable-partial.png" alt="partial"></p>
</li>
<li><p>Entirely visible on screen when the height of a item is bigger than the <code>viewportHeight</code>.</p>
</li>
</ol>
<p><img src="entire-viewable.png" alt="7c4f2df0.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/ViewabilityHelper.js#L64">ref</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_isViewable</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  viewAreaMode: boolean,</span></span></span><br><span class="line"><span class="params"><span class="function">  viewablePercentThreshold: number,</span></span></span><br><span class="line"><span class="params"><span class="function">  top: number,</span></span></span><br><span class="line"><span class="params"><span class="function">  bottom: number,</span></span></span><br><span class="line"><span class="params"><span class="function">  viewportHeight: number,</span></span></span><br><span class="line"><span class="params"><span class="function">  itemLength: number,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_isEntirelyVisible(top, bottom, viewportHeight)) &#123;</span><br><span class="line">    <span class="comment">// Entirely visible </span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Get viewable height of this item cell </span></span><br><span class="line">    <span class="keyword">const</span> pixels = _getPixelsVisible(top, bottom, viewportHeight);</span><br><span class="line">    <span class="comment">// Get the viewable percentage of this item cell </span></span><br><span class="line">    <span class="keyword">const</span> percent =</span><br><span class="line">      <span class="number">100</span> * (viewAreaMode ? pixels / viewportHeight : pixels / itemLength);</span><br><span class="line">    <span class="keyword">return</span> percent &gt;= viewablePercentThreshold;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_getPixelsVisible</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  top: number,</span></span></span><br><span class="line"><span class="params"><span class="function">  bottom: number,</span></span></span><br><span class="line"><span class="params"><span class="function">  viewportHeight: number,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> visibleHeight = <span class="built_in">Math</span>.min(bottom, viewportHeight) - <span class="built_in">Math</span>.max(top, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.max(<span class="number">0</span>, visibleHeight);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_isEntirelyVisible</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  top: number,</span></span></span><br><span class="line"><span class="params"><span class="function">  bottom: number,</span></span></span><br><span class="line"><span class="params"><span class="function">  viewportHeight: number,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> top &gt;= <span class="number">0</span> &amp;&amp; bottom &lt;= viewportHeight &amp;&amp; bottom &gt; top;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/ViewabilityHelper.js#L300">code here</a></p>
<h3 id="Timer-and-Schedule"><a href="#Timer-and-Schedule" class="headerlink" title="Timer and Schedule"></a>Timer and Schedule</h3><p>In <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/ViewabilityHelper.js#L228"><code>onUpdate</code> func in ViewabilityHelper</a>, if we define <code>minimumViewTime</code> value, the <code>_onUpdateSync</code> is scheduled to be called. It is the handler of the <code>timeout</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>._viewableIndices = viewableIndices;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>._config.minimumViewTime) &#123;</span><br><span class="line">     <span class="keyword">const</span> handle = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>._timers.delete(handle);</span><br><span class="line">       <span class="comment">// filter out  indices that have gone out of view after minimumViewTime </span></span><br><span class="line">       <span class="comment">// figure out which items are gone, which items are showing </span></span><br><span class="line">       <span class="built_in">this</span>._onUpdateSync(</span><br><span class="line">         viewableIndices,</span><br><span class="line">         onViewableItemsChanged,</span><br><span class="line">         createViewToken,</span><br><span class="line">       );</span><br><span class="line">     &#125;, <span class="built_in">this</span>._config.minimumViewTime);</span><br><span class="line">     <span class="built_in">this</span>._timers.add(handle);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>._onUpdateSync(</span><br><span class="line">       viewableIndices,</span><br><span class="line">       onViewableItemsChanged,</span><br><span class="line">       createViewToken,</span><br><span class="line">     );</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>And, If after a few seconds, ${minimumViewTime}, if some items aren’t longer viewable, the <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/84adc85523770ebfee749a020920e0b216cf69f8/Libraries/Lists/ViewabilityHelper.js#L267">_onUpdateSync</a> func, filter out these indices that have gone out of viewport.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Filter out indices that have gone out of view after `minimumViewTime`</span></span><br><span class="line">viewableIndicesToCheck = viewableIndicesToCheck.filter(<span class="function"><span class="params">ii</span> =&gt;</span></span><br><span class="line">  <span class="built_in">this</span>._viewableIndices.includes(ii),</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/img/9af4f3b0-fe64-4a98-b94e-d456f65ae7cc/99830c30.png" alt="99830c30.png"></p>
<p>In the above graph, at first, the <code>_viewableIndices</code> is from 1 to 9. Then the user scrolls the <code>VirtualizedList</code>  and the <code>_onUpdateSync</code> is triggered after <code>minimumViewTime</code>. At this moment, the current <code>_viewableIndices</code> is from 2 to 10. So the item indexed 1 is filtered out.</p>
<h3 id="6-How-to-get-changed-items"><a href="#6-How-to-get-changed-items" class="headerlink" title="6. How to get changed items"></a>6. How to get changed items</h3><p>Comparing with the last time when  <code>onViewableItemsChanged</code> is triggered, at this time to trigger  <code>onViewableItemsChanged</code>. Some viewable items will be out of the screen, some hidden items will become viewable. In <code>_onUpdateSync</code> function, the <code>preItems</code>  map stores the information about previous visible items, the previous means last time when <code>VirtualizedList</code> calls <code>onViewableItemsChanged</code>. Now it has a <code>nextItems</code> map, which stores the information about viewable items this time. Then it figures out the <code>changed</code> items by comparing these two maps. Then, it calls <code>onViewableItemsChanged</code>, passing <code>viewableItems</code> and <code>changed</code> items. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">_onUpdateSync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    viewableIndicesToCheck,</span></span></span><br><span class="line"><span class="params"><span class="function">    onViewableItemsChanged,</span></span></span><br><span class="line"><span class="params"><span class="function">    createViewToken,</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>)</span> &#123;</span><br><span class="line">    <span class="comment">// Filter out indices that have gone out of view since this call was scheduled.</span></span><br><span class="line">    viewableIndicesToCheck = viewableIndicesToCheck.filter(<span class="function"><span class="params">ii</span> =&gt;</span></span><br><span class="line">      <span class="built_in">this</span>._viewableIndices.includes(ii),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> prevItems = <span class="built_in">this</span>._viewableItems;</span><br><span class="line">    <span class="comment">// Using map, so the time complexity would be o(n) </span></span><br><span class="line">    <span class="keyword">const</span> nextItems = <span class="keyword">new</span> <span class="built_in">Map</span>(</span><br><span class="line">      viewableIndicesToCheck.map(<span class="function"><span class="params">ii</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> viewable = createViewToken(ii, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> [viewable.key, viewable];</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> changed = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [key, viewable] <span class="keyword">of</span> nextItems) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!prevItems.has(key)) &#123;</span><br><span class="line">        changed.push(viewable);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [key, viewable] <span class="keyword">of</span> prevItems) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!nextItems.has(key)) &#123;</span><br><span class="line">        changed.push(&#123;...viewable, <span class="attr">isViewable</span>: <span class="literal">false</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (changed.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>._viewableItems = nextItems;</span><br><span class="line">      onViewableItemsChanged(&#123;</span><br><span class="line">        <span class="attr">viewableItems</span>: <span class="built_in">Array</span>.from(nextItems.values()),</span><br><span class="line">        changed,</span><br><span class="line">        <span class="attr">viewabilityConfig</span>: <span class="built_in">this</span>._config,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#Popular Article" >
    <span class="tag-code">Popular Article</span>
  </a>

  <a href="/tags#Dive into React Native" >
    <span class="tag-code">Dive into React Native</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2019/07/12/Gaussian-Filter/">
        <span class="nav-arrow">← </span>
        
          Gaussian Filter
        
      </a>
    
    
      <a class="nav-right" href="/2020/02/05/iOS-Simulator-from-the-Command-Line/">
        
          iOS Simulator from the Command Line
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
  
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">scan qr code and share this article</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo=""
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#What-is-onViewableItemsChanged"><span class="toc-nav-text">What is onViewableItemsChanged</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#How-to-use-it"><span class="toc-nav-text">How to use it</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#How-does-onViewableItemsChanged-works"><span class="toc-nav-text">How does onViewableItemsChanged works</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Viewable-Region"><span class="toc-nav-text">Viewable Region</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Overview"><span class="toc-nav-text">Overview</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Different-viewabilityConfig-in-one-VirtualizedList"><span class="toc-nav-text">Different viewabilityConfig  in one VirtualizedList</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Items%E2%80%99-layout"><span class="toc-nav-text">Items’ layout</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#How-to-find-out-viewable-items"><span class="toc-nav-text">How to find out viewable items</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#How-to-get-the-indexes-of-viewable-items"><span class="toc-nav-text">How to get the indexes of viewable items</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#What-kind-of-item-is-viewable"><span class="toc-nav-text">What kind of item is viewable</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Timer-and-Schedule"><span class="toc-nav-text">Timer and Schedule</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#6-How-to-get-changed-items"><span class="toc-nav-text">6. How to get changed items</span></a></li></ol></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://suelan.github.io/2020/01/21/onViewableItemsChanged/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2022 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>