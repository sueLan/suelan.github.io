<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="RY&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" type="image/ico" href="[object Object]"/>
  
  <title>
    
      Crash - ate bad food (0x8badf00d) | RY &#39;s Blog
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 5.2.0"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>RY 's Blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/series/" class="item-link">Series</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/series/" class="menu-link">Series</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>Crash - ate bad food (0x8badf00d)</h2>
  <p class="post-date">2021-03-05</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>Recently, my colleague came to me for a crash report. It is a case where system watch dog kills our app for blocking <code>main thread</code> for too long time. It seems many people encounter issues of this sorts from time to time. However, there are a few articles about it. I hope this article could help you. </p>
<h2 id="Exception-Type"><a href="#Exception-Type" class="headerlink" title="Exception Type"></a>Exception Type</h2><p>As we know, a crash report records app’s state when it crashed. It is a crucial and first-hand resource to help us figure out what was happening when a crash happened in user’s device. When i to a crash report. I always try to extract as much information as I can. Apple actually has dedicated article about how to <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/analyzing_a_crash_report">analyze a crash report</a>. </p>
<p>In this case, firstly, we can take a look at exception type, which is <code>EXC_CRASH (SIGKILL)</code>. <code>EXC_CRASH (SIGKILL)</code> indicates the operating system terminated the process. See more <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/understanding_the_exception_types_in_a_crash_report#3582412">here</a>. </p>
<p>The crash report also contains a <code>Termination Reason</code> field with a code that explains the reason for the crash. Here, that code is <code>0xdead10cc</code>:</p>
<ul>
<li><code>0x8badf00d</code> (pronounced “ate bad food”). The operating system’s watchdog terminated the app. See <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/identifying_the_cause_of_common_crashes/addressing_watchdog_terminations">Addressing Watchdog Terminations</a>.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Exception Type:  EXC_CRASH (SIGKILL)</span><br><span class="line">Exception Codes: 0x0000000000000000, 0x0000000000000000</span><br><span class="line">Exception Note:  EXC_CORPSE_NOTIFY</span><br><span class="line">Termination Reason: Namespace SPRINGBOARD, Code 0x8badf00d</span><br><span class="line">Termination Description: SPRINGBOARD, scene-update watchdog transgression: application&lt;.......&gt;:307 exhausted real (wall clock) time allowance of 10.00 seconds | ProcessVisibility: Background | ProcessState: Running | WatchdogEvent: scene-update | WatchdogVisibility: Background | WatchdogCPUStatistics: ( | &quot;Elapsed total CPU time (seconds): 39.500 (user 39.500, system 0.000), 39% CPU&quot;, | &quot;Elapsed application CPU time (seconds): 21.283, 21% CPU&quot; | )</span><br><span class="line">Triggered by Thread:  0</span><br></pre></td></tr></table></figure>
<h3 id="WatchDog"><a href="#WatchDog" class="headerlink" title="WatchDog"></a>WatchDog</h3><p>As we know, iOS has watchdog oto ensure application not drag down the system responsiveness. If your app has poor performance, watchdog will check then kill you app to make sure the shared resource well allocated.  It is dev’s duty to maintain system responsiveness. The following table showing some cases for watchdog check, it comes from this <a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2011/312/">session</a>,</p>
<p><img src="image-20210305194510328.png" alt="image-20210305194510328.png" style="zoom:50%;" /></p>
<p>As for scenarios, Slow launch will cause OS to abort your app. <code>20 sec</code>; resume and suspend is also very important <code>10sec</code>; smooth scrolling <code>6s</code> is also a key point. Besides, I also have seen <code>blocking main thread</code>  will cause watchdog kill an app, like this </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">transgression: application&lt;com.wangya.test2&gt;:21021 exhausted real (wall clock) time allowance of 19.99 seconds </span><br><span class="line">Triggered by Thread:  0</span><br></pre></td></tr></table></figure>
<p>The <code>Termination Description</code>  in my crash report shows our app <code>exhausted real (wall clock) time allowance of 10.00 seconds</code>.  Besides, the <code>ProcessVisibility</code> shows it is <code>Background</code> and <code>ProcessState</code> is <code>Running</code>.  It seems the crashed happened when it tried to resumed from background. But what caused it? </p>
<h3 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h3><p>So we have to go to the stack trace in the crashed report. Unfortunately, he gave me a partially symbolicated crash report with <code>CoreData</code> related method remaining hexadecimal memory address. From the frame in our app, i know operations related to <code>CoreData</code> happening in <code>main thread</code>. Then, I have to symbolicate the crash report. </p>
<h3 id="Symbolicate"><a href="#Symbolicate" class="headerlink" title="Symbolicate"></a>Symbolicate</h3><p>Apple actually has doc to <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/adding_identifiable_symbol_names_to_a_crash_report#3403794">symbolicate the Crash Report in Xcode</a>  or <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/adding_identifiable_symbol_names_to_a_crash_report#3403800">symbolicate the crash report with the command line</a>. </p>
<blockquote>
<p>To symbolicate in Xcode, click the Device Logs button in the <a target="_blank" rel="noopener" href="https://help.apple.com/xcode/mac/current/#/dev85c64ec79">Devices and Simulators window</a>, then drag and drop the crash report file into the list of device logs. And, crash reports must have the <code>.crash</code> file extension. </p>
</blockquote>
<p><img src="https://help.apple.com/xcode/mac/current/en.lproj/Art/dw_view_crash_logs.png" alt="img"></p>
<p> As Apple’s doc, <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/adding_identifiable_symbol_names_to_a_crash_report#3403795">Acquire Device Symbol Information</a> says, I have to collect symbols for system frameworks like <code>CoreData</code> from the device where crashed happened.</p>
<blockquote>
<p>The symbols for system frameworks are specific to the operating system release and the CPU architecture of the device. For example, the symbols for an iPhone running iOS 13.1.0 aren’t the same as the symbols for the same iPhone running iOS 13.1.2. </p>
</blockquote>
<p>Unfortunately, I don’t have  the device on hand to get the symbol information matching the operating system version recorded in the crash report. How to solve it? Well, I still have a way to work around. Let’s start to do that.</p>
<ol>
<li><p>Check the os version and hardware model from the crash report. OS Version: <code>iPhone OS 13.3.1 (17D50); Hardware model:</code>Hardware Model:      iPhone11,8`</p>
</li>
<li><p>download <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/IPSW">IPSW</a>, iPod Software from  <a target="_blank" rel="noopener" href="https://www.theiphonewiki.com/wiki/Firmware/iPhone/11.x">https://www.theiphonewiki.com/wiki/Firmware/iPhone/11.x</a> or <a target="_blank" rel="noopener" href="https://ipsw.me/">https://ipsw.me/</a>; or can decrypte <code>ipsw</code> by yourself following this <a target="_blank" rel="noopener" href="https://gist.github.com/tzmartin/812027b879f6ff4459af">guide</a></p>
</li>
<li><p><code>IPSW</code> file actually is <code>zip</code> file, we can change the file extension <code>ipsw</code> to <code>zip</code>. Then unzip it. You can see a big disk image there.</p>
<p><img src="image-20210305201936593.png" alt=""></p>
<p> Double click it. It will be mounted in filesystem. Then we can see it showing in the <code>Finder</code> </p>
<p><img src="image-20210305202238201.png" alt=""></p>
</li>
<li><p>Then go to <code>/System/Library/Caches/com.apple.dyld</code> folder. Drag this file to <code>Hopper</code></p>
<p><img src="image-20210305202347747.png" alt=""></p>
</li>
<li><p>Since all executable dylib are shipped into this whole file, we have to filter out <code>CoreData</code> in the search bar. </p>
<p><img src="image-20210305202507076.png" alt=""></p>
</li>
<li><p>Get <code>offset</code> from frame in the backtrace in the crash report.  Using <code>go to file offset</code>  in Hopper, <code>option + g</code> to jump to that line of assembly code. I actually have a <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=GPs3oPFSdo0">talk</a> about how to use exception info, thread state, offset in backtrace in crash report  to analyze crash report. </p>
<p><img src="image-20210305204358148.png" alt=""></p>
<p>take <code>line 29</code> as an example, it goes to a <code>bl</code> instruction. As we know, in Objective-C, <code>x1</code> stores the sector. So we can quickly figure out the selector is </p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/coredata/nspersistentstorecoordinator/1468872-executerequest?language=objc">executeRequest:withContext:error:</a></p>
<p><img src="image-20210305204545965.png" alt=""></p>
<p>Hmm, although it is a little bit tedious, we finanly get more info about what is happening here. </p>
<p>Basically, when resuming from background, our app triggers a data request operation in <code>CoreData</code>. It is executed in <code>main thread</code> and make the main thread wait this transaction finished. While,  it is a bit of slow to execute this SQL-related transaction here and blocks <code>main thread</code> for extended period of time. Then when watchdog come to check, it terminates our app in order to maintain the system responsiveness. </p>
</li>
</ol>
<p><img src="image-20210305210726254.png" alt=""></p>
<p>As apple suggests, the watchdog terminates apps that block the main thread for a significant time.  There are some cases of this sort, like </p>
<ul>
<li>Synchronous networking</li>
<li>Processing large amouts of data, such as large JSON files or 3D models</li>
<li>Triggering lightweight migration for a large <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/coredata">Core Data</a> store synchronously</li>
<li>Analysis requests with <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/vision">Vision</a></li>
</ul>
<p>This time, we ate bad food. </p>
<h3 id="See-More"><a href="#See-More" class="headerlink" title="See More"></a>See More</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/identifying_the_cause_of_common_crashes/addressing_watchdog_terminations">Addressing Watchdog Terminations</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/identifying_the_cause_of_common_crashes/investigating_memory_access_crashes">Investigating Memory Access Crashes</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/analyzing_a_crash_report">Analyzing a Crash Report</a></p>
</li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/59827727/ios-frequently-getting-exhausted-real-wall-clock-time-allowance-of-10-00-seco">0x8badf00d in main thread</a></li>
</ul>
</section>
    <!-- Tags START -->
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2021/02/13/20210213-ensure-null-terminated-string/">
        <span class="nav-arrow">← </span>
        
          Ensure Null-Terminated JS Bundle in React Native
        
      </a>
    
    
      <a class="nav-right" href="/2021/03/05/20210305-pointer-authentication-failed/">
        
          Crash - Pointer Authentication Failures or invalid memory accesses
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo="null"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Exception-Type"><span class="toc-nav-text">Exception Type</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#WatchDog"><span class="toc-nav-text">WatchDog</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Backtrace"><span class="toc-nav-text">Backtrace</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Symbolicate"><span class="toc-nav-text">Symbolicate</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#See-More"><span class="toc-nav-text">See More</span></a></li></ol></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://suelan.github.io/2021/03/05/20210305-crash-ate-bad-food/';
    var banner = 'undefined'
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2021 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>