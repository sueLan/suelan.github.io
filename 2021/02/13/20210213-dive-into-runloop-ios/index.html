<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="RY&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" type="image/ico" href="[object Object]"/>
  
  <title>
    
      Dive into CFRunLoop | RY &#39;s Blog
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 5.2.0"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>RY 's Blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/series/" class="item-link">Series</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/series/" class="menu-link">Series</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>Dive into CFRunLoop</h2>
  <p class="post-date">2021-02-13</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Sometimes, you may want to collect on-device performance metrics in main thread to know how our App performs and help you find more clues to  analyse performance issue. <a href="MetricKit">MetricKit</a> is a useful utility framework to achieve that. It starts accumulating reports for your app after being called for the first time and delivers reports at most once per day. The reports contain the metrics from the past 24 hours and any previously undelivered daily reports. Then, you can go to <code>Xcode-&gt;Organizer-&gt;Metric</code> panel to check these info. However, you may want your in-house App Performance Monitoring framework to gain more controls on when to collect metrics, or how to upload it, or collect what you want. Earlier days, <code>Tencent</code> launched a <a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix">iOS framework called matrix</a> to monitor App performance metrics. When I explored this library, I saw they use <code>CFRunLoop</code> to detect hitch in the thread, like main thread. This intrigued me. So I investigated <code>CFRunLoop</code> to learn more. </p>
<h2 id="What-is-RunLoop-in-iOS"><a href="#What-is-RunLoop-in-iOS" class="headerlink" title="What is RunLoop in iOS?"></a>What is RunLoop in iOS?</h2><p>Before talking about RunLoop in iOS, we may have to know something about event loop and thread.  In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/OS/360_and_successors#MVT">OS/360 Multiprogramming with a Variable Number of Tasks</a> (MVT) in 1967, threads made an early appearance under the name of “tasks”. A <strong>thread</strong> in computer science  is short for a <em>thread of execution</em>. Once the tasks in one Thread is all done, the thread finishes its job and exits. Sometimes, we need a way to keep it alive and handling events.  Then,  comes the event loop. The psudo code for event loop is like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loop</span></span></span><br><span class="line"><span class="function">    <span class="title">initialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">while</span> <span class="title">message</span> != <span class="title">quit</span></span></span><br><span class="line"><span class="function">        <span class="title">message</span> := <span class="title">get_next_message</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        <span class="title">process_message</span>(<span class="params">message</span>)</span></span><br><span class="line"><span class="function">    <span class="title">end</span> <span class="title">while</span></span></span><br><span class="line"><span class="function"><span class="title">end</span> <span class="function"><span class="keyword">function</span></span></span></span><br></pre></td></tr></table></figure>
<p>In Wikipedia, event loop is a programming construct or <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Software_design_pattern">design pattern</a> that waits for and dispatches <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Event-driven_programming">events</a> or <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Message_Passing_Interface">messages</a> in a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_program">program</a>.  In this event loop, it keeps <code>waiting events -&gt; receive events -&gt; handle events</code> until the exit condition is met. </p>
<blockquote>
<p>Run loops are part of the fundamental infrastructure associated with threads. A <em>run loop</em> is an event processing loop that you use to schedule work and coordinate the receipt of incoming events. The purpose of a run loop is to keep your thread busy when there is work to do and put your thread to sleep when there is none.</p>
</blockquote>
<blockquote>
<p>A CFRunLoop object monitors sources of input to a task and dispatches control when they become ready for processing.  </p>
</blockquote>
<p>A run loop receives events from two different types of sources. <code>Input sources</code> deliver asynchronous events, usually messages from another thread or from a different application. <code>Timer sources</code> deliver synchronous events, occurring at a scheduled time or repeating interval.  </p>
<p>It can handle </p>
<ul>
<li><p>user input devices</p>
</li>
<li><p>port objects </p>
</li>
<li><p>network connections</p>
</li>
<li><p>periodic or time-delayed events</p>
</li>
<li><p>asynchronous callbacks</p>
<p><img src="image-20210128230441389.png" alt="image-20210128230441389"></p>
</li>
</ul>
<p>In Apple’s doc,  this kind of event loop is implemented by <code>CFRunLoop</code> in low-level. In cocoa, the object is an instance of <code>NSRunLoop</code> There is exactly one run loop per thread. </p>
<p>Apple provides two APIs to get runloop object </p>
<ul>
<li><code>CFRunLoopGetMain()</code> // the main CFRunLoop object</li>
<li><code>CFRunLoopGetCurrent()</code> // CFRunLoop object for the current thread</li>
</ul>
<h2 id="RunLoop-Mode"><a href="#RunLoop-Mode" class="headerlink" title="RunLoop Mode"></a>RunLoop Mode</h2><blockquote>
<p>A <em>run loop mode</em> is a collection of input sources and timers to be monitored and a collection of run loop observers to be notified. Each time you run your run loop, you specify (either explicitly or implicitly) a particular “mode” in which to run.During that pass of the run loop, only sources associated with that mode are monitored and allowed to deliver their events.   — <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW23">doc</a></p>
</blockquote>
<p>A run loop mode contains a set of <code>CFRunLoopSource</code>, a list of <code>CFRunLoopTimer</code> and <code>CFRunLoopObservers</code>. They are all inputs for runloop. </p>
<p><img src="image-20210128223829153.png" alt="image-20210128223829153"></p>
<h2 id="Inputs"><a href="#Inputs" class="headerlink" title="Inputs"></a>Inputs</h2><p>Three kinds of inputs can be monitored by a run loop </p>
<ul>
<li>CFRunLoopSource </li>
<li>CFRunLoopTimer</li>
<li>CFRunLoopObservers</li>
</ul>
<h3 id="Input-Source-CFRunLoopSource"><a href="#Input-Source-CFRunLoopSource" class="headerlink" title="Input Source  - CFRunLoopSource"></a>Input Source  - CFRunLoopSource</h3><p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/cfrunloopsource-rhr">CFRunLoopSource</a></p>
<blockquote>
<p>A CFRunLoopSource object is an abstraction of an input source that can be put into a run loop. Input sources typically generate asynchronous events, such as messages arriving on a network port or actions performed by the user.</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopSource</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">uint32_t</span> _bits;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;</span><br><span class="line">    CFIndex _order;			<span class="comment">/* immutable */</span></span><br><span class="line">    CFMutableBagRef _runLoops;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">4      CFRunLoopSourceContext version0;	<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">        CFRunLoopSourceContext1 version1;	<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">    &#125; _context;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>_context</code> is a <code>union</code> type. A union looks like a structure, but  it will use the memory space for just one of the fields in its definition. So the <code>_context</code> is either an <code>CFRunLoopSourceContext</code>    structure or <code>CFRunLoopSourceContext1</code> structure.</p>
<h4 id="Two-categories-of-Input-Source"><a href="#Two-categories-of-Input-Source" class="headerlink" title="Two categories of Input Source"></a>Two categories of Input Source</h4><p>As it is mentioned in this <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW23">doc</a>, we mainly care about two categories, <code>port-base</code> input sources, source1,  and <code>non-port-based</code> input sources, source0, also called custom sources. </p>
<ul>
<li>Version 0 sources, so named because the <code>version</code> field of their context structure is 0, are managed manually by the <code>application</code>.<ul>
<li>When a source is ready to fire, some part of the <code>application</code>, perhaps code on a separate<code>thread</code> waiting for an event, must call <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/1543700-cfrunloopsourcesignal"><code>CFRunLoopSourceSignal(_:)</code></a> to tell the run loop that the source is ready to fire. </li>
<li>custom input source that allows you to perform a selector on any thread. Like <code>performSelectorOnMainThread:withObject:waitUntilDone:</code> , <code>performSelector:withObject:afterDelay:</code>. see more</li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW3">Defining a Custom Input Source</a></li>
</ul>
</li>
<li>Version 1 sources are managed by the run loop and kernel. <ul>
<li>These sources use <code>Mach ports</code> to signal when the sources are ready to fire. </li>
<li>A source is automatically <code>signaled by the kernel</code> when a message arrives on the source’s Mach port.</li>
<li>see <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-131281">Configuring a Port-Based Input Source</a><br><img src="image-20210125183432020.png" alt="image-20210125183432020"></li>
</ul>
</li>
</ul>
<h4 id="bits-field"><a href="#bits-field" class="headerlink" title="bits field"></a><code>bits</code> field</h4><p>It seems that <code>bits</code> field is used to mark the status of the <code>CFRunLoopSouceRef</code> .  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CF_INLINE Boolean __CFRunLoopSourceIsSignaled(CFRunLoopSourceRef rls) &#123;</span><br><span class="line">    <span class="keyword">return</span> (Boolean)__CFBitfieldGetValue(rls-&gt;_bits, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CF_INLINE <span class="keyword">void</span> __CFRunLoopSourceSetSignaled(CFRunLoopSourceRef rls) &#123;</span><br><span class="line">    __CFBitfieldSetValue(rls-&gt;_bits, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CF_INLINE <span class="keyword">void</span> __CFRunLoopSourceUnsetSignaled(CFRunLoopSourceRef rls) &#123;</span><br><span class="line">    __CFBitfieldSetValue(rls-&gt;_bits, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/1543700-cfrunloopsourcesignal">CFRunLoopSourceSignal</a> is used to signals a <code>version 0 source</code> , marking it as ready to fire. It actually updated the <code>bits</code> in the  <code>CFRunLoopSouceRef</code> structure. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFRunLoopSourceSignal</span><span class="params">(CFRunLoopSourceRef rls)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">CHECK_FOR_FORK</span>();</span><br><span class="line">    __CFRunLoopSourceLock(rls);</span><br><span class="line">    <span class="keyword">if</span> (__CFIsValid(rls)) &#123;</span><br><span class="line">4__CFRunLoopSourceSetSignaled(rls);</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopSourceUnlock(rls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CFRunLoopTimer"><a href="#CFRunLoopTimer" class="headerlink" title="CFRunLoopTimer"></a>CFRunLoopTimer</h3><p>Besides <code>CFRunLoopSource</code>, there is another input for runloop. Timer Source, <code>CFRunLoopTimer</code>, which represents a specialized run loop source that fires at a preset time in the future.  see <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/cfrunlooptimer-rhk">doc for CFRunLoopTimer</a></p>
<p>There are two conditions for a timer to be fired: </p>
<ul>
<li>one of the run loop modes to which the timer has been added is running </li>
<li>the timer’s firing time has passed</li>
</ul>
<h4 id="a-timer-is-not-a-real-time-mechanism"><a href="#a-timer-is-not-a-real-time-mechanism" class="headerlink" title="a timer is not a real-time mechanism"></a>a timer is not a real-time mechanism</h4><ol>
<li>Like input sources, timers are associated with specific modes of your run loop. If a timer is not in the mode currently being monitored by the run loop, it does not fire until you run the run loop in one of the timer’s supported modes. </li>
<li>If a timer fires when the run loop is in the middle of executing a handler routine, the timer waits until the next time through the run loop to invoke its handler routine. </li>
<li>If the run loop is not running at all, the timer never fires.</li>
</ol>
<p>In Cocoa, you can create and schedule a timer all at once using either of these class methods:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scheduledTimerWithTimeInterval:target:selector:userInfo:repeats:</span><br><span class="line">scheduledTimerWithTimeInterval:invocation:repeats:</span><br></pre></td></tr></table></figure>
<p>You can also create your <code>NSTimer</code> object and then add it to the run loop using the <code>addTimer:forMode:</code> method of <code>NSRunLoop</code>.<br>see <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW6">how to configure timer source here</a></p>
<h3 id="RunLoopObserver"><a href="#RunLoopObserver" class="headerlink" title="RunLoopObserver"></a>RunLoopObserver</h3><h4 id="How-to-use-observer"><a href="#How-to-use-observer" class="headerlink" title="How to use observer"></a>How to use observer</h4><ol>
<li>We can use these two APIs to create RunLoopObserver and associated it with handlers. </li>
</ol>
<ul>
<li>CFRunLoopObserverCreate(_:_:_:_:_:_:)</li>
<li>CFRunLoopObserverCreateWithHandler(_:_:_:_:_:)</li>
</ul>
<ol start="2">
<li><p>add the observer into the runloop </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  CFRunLoopObserverRef runloopObserver = CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, kCFRunLoopBeforeWaiting, YES, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity activity) &#123;   </span><br><span class="line">   // handler code here  </span><br><span class="line">&#125;);</span><br><span class="line">   </span><br><span class="line">  CFRunLoopAddObserver(CFRunLoopGetMain(), runloopObserver, kCFRunLoopDefaultMode);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Observe specific RunLoop Activity </p>
</li>
</ol>
<h2 id="RunLoop-Activity"><a href="#RunLoop-Activity" class="headerlink" title="RunLoop Activity"></a>RunLoop Activity</h2><blockquote>
<p>The run loop stages in which an observer is scheduled are selected when the observer is created with <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/1541546-cfrunloopobservercreate?language=objc"><code>CFRunLoopObserverCreate</code></a>.       -<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/cfrunloopactivity?language=objc">doc</a></p>
</blockquote>
<p>There are several kinds of RunLoop Activity for CFRunLoop. You can associate run loop observers with these RunLoopActivity</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Run Loop Observer Activities */</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">CF_OPTIONS</span><span class="params">(CFOptionFlags, CFRunLoopActivity)</span> </span>&#123;</span><br><span class="line">    kCFRunLoopEntry = (<span class="number">1UL</span> &lt;&lt; <span class="number">0</span>), <span class="comment">// The entrance of the run loop, before entering the event processing loop. This activity occurs once for each call to CFRunLoopRun() and CFRunLoopRunInMode(_:_:_:).</span></span><br><span class="line">    kCFRunLoopBeforeTimers = (<span class="number">1UL</span> &lt;&lt; <span class="number">1</span>), <span class="comment">// Inside the event processing loop before any timers are processed.</span></span><br><span class="line">    kCFRunLoopBeforeSources = (<span class="number">1UL</span> &lt;&lt; <span class="number">2</span>), <span class="comment">// Inside the event processing loop before any sources are processed.</span></span><br><span class="line">    kCFRunLoopBeforeWaiting = (<span class="number">1UL</span> &lt;&lt; <span class="number">5</span>), </span><br><span class="line">    kCFRunLoopAfterWaiting = (<span class="number">1UL</span> &lt;&lt; <span class="number">6</span>),  <span class="comment">// Inside the event processing loop after the run loop wakes up, but before processing the event that woke it up. This activity occurs only if the run loop did in fact go to sleep during the current loop.</span></span><br><span class="line">    kCFRunLoopExit = (<span class="number">1UL</span> &lt;&lt; <span class="number">7</span>), <span class="comment">// The exit of the run loop, after exiting the event processing loop. This activity occurs once for each call to CFRunLoopRun() and CFRunLoopRunInMode(_:_:_:).</span></span><br><span class="line">    kCFRunLoopAllActivities = <span class="number">0x0FFFFFFF</span>U </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/cfrunloopactivity">https://developer.apple.com/documentation/corefoundation/cfrunloopactivity</a> </p>
<h3 id="Run-Loop-Sequence-of-Events"><a href="#Run-Loop-Sequence-of-Events" class="headerlink" title="Run Loop Sequence of Events"></a>Run Loop Sequence of Events</h3><p>According to <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW1">apple doc</a>,  when runloop running  in a thread, it processes pending events and generates notifications for attached observers.  Briefly, it works as the follow diagram shows. </p>
<p><img src="image-20210209142244931.png" alt="image-20210209142244931"></p>
<p>The implementation is in <code>CFRunLoopRunSpecific</code> and <code>__CFRunLoopRun</code> in <code>CFRunloop.c</code> . </p>
<h2 id="Use-case"><a href="#Use-case" class="headerlink" title="Use case"></a>Use case</h2><h3 id="Detect-hitch-block-in-main-thread"><a href="#Detect-hitch-block-in-main-thread" class="headerlink" title="Detect hitch block in main thread"></a>Detect hitch block in main thread</h3><p> In <a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix">Tencent matrix</a>, it leverages the Run Loop notifications to record timestamp when these notifications sent. </p>
<ol>
<li><p>create and add RunLoopObserver to current RunLoop <a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix/blob/c7fd99237af189fb060f90d1272350db19182dbf/matrix/matrix-iOS/Matrix/WCCrashBlockMonitor/CrashBlockPlugin/Main/BlockMonitor/WCBlockMonitorMgr.mm#L831">CFRunLoopAddObserver</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix/blob/c7fd99237af189fb060f90d1272350db19182dbf/matrix/matrix-iOS/Matrix/WCCrashBlockMonitor/CrashBlockPlugin/Main/BlockMonitor/WCBlockMonitorMgr.mm#L858">record timestamp</a> in callback function invoked when the observer runs</p>
</li>
<li>start a <a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix/blob/c7fd99237af189fb060f90d1272350db19182dbf/matrix/matrix-iOS/Matrix/WCCrashBlockMonitor/CrashBlockPlugin/Main/BlockMonitor/WCBlockMonitorMgr.mm#L478">monitor thread</a>, then <a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix/blob/c7fd99237af189fb060f90d1272350db19182dbf/matrix/matrix-iOS/Matrix/WCCrashBlockMonitor/CrashBlockPlugin/Main/BlockMonitor/WCBlockMonitorMgr.mm#L498">check periodically</a></li>
<li>get the<a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix/blob/c7fd99237af189fb060f90d1272350db19182dbf/matrix/matrix-iOS/Matrix/WCCrashBlockMonitor/CrashBlockPlugin/Main/BlockMonitor/WCBlockMonitorMgr.mm#L612">timestamp diff</a> to see if it is greater than threshold, <a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix/blob/c7fd99237af189fb060f90d1272350db19182dbf/matrix/matrix-iOS/Matrix/WCCrashBlockMonitor/CrashBlockPlugin/Main/BlockMonitor/WCBlockMonitorMgr.mm#L630">g_RunLoopTimeOut</a></li>
</ol>
<p>I did a small experiment to better understand it. I added a RunLoop Observer to the runloop in main thread. Then calculate the time gap between <code>kCFRunLoopBeforeTimers</code> notification in two continuous loop. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. create runloop observer </span></span><br><span class="line">CFRunLoopObserverRef beginObserver = <span class="built_in">CFRunLoopObserverCreate</span>(kCFAllocatorDefault, kCFRunLoopAllActivities, YES, LONG_MIN, &amp;myRunLoopCallback, &amp;context);</span><br><span class="line"><span class="comment">// 2.  add observer to runloop in the main thread</span></span><br><span class="line"><span class="built_in">CFRunLoopAddObserver</span>([[NSRunLoop mainRunLoop] getCFRunLoop], beginObserver, kCFRunLoopCommonModes);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. implemented callback for RunLoop observer </span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">myRunLoopCallback</span><span class="params">(CFRunLoopObserverRef observer, CFRunLoopActivity activity, <span class="keyword">void</span> *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="built_in"><span class="keyword">switch</span></span> (activity) &#123;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopEntry:</span><br><span class="line">             self.isRunloopRunning = YES;</span><br><span class="line">             <span class="keyword">break</span>;       </span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeTimers:</span><br><span class="line">             <span class="built_in">NSLog</span>(@<span class="string">&quot;[RY]kCFRunLoopBeforeTimers called %@&quot;</span>, @(<span class="built_in">getCurrentMilliTimestamp</span>() - monitor.runloopMilliTimestamp));</span><br><span class="line">             self.runloopMilliTimestamp = <span class="built_in">getCurrentMilliTimestamp</span>();</span><br><span class="line">             self.isRunloopRunning = YES;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeSources:</span><br><span class="line">             self.isRunloopRunning = YES;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeWaiting:</span><br><span class="line">             self.isRunloopRunning = NO;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopAfterWaiting:</span><br><span class="line">             self.isRunloopRunning = YES;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopExit:</span><br><span class="line">             self.isRunloopRunning = NO;</span><br><span class="line">             <span class="keyword">break</span>;b</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Theoretically,  the time diff between  two continuous <code>kCFRunLoopBeforeTimers</code> notification should be within <code>16.67ms</code> to achieve smooth user experience in main thread, which means <code>RunLoop</code> runs 60 times per second. In the following log, one frame takes about <code>72ms</code> to executed.<br>However, since I put the logger in <code>kCFRunLoopBeforeTimers</code>, this may not be a hitch. It could be caused thread was sleeping while there is no event come. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> [RY]kCFRunLoopBeforeTimers called 3.628173828125</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 17.784912109375</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.041015625</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 1.23388671875</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 72.05419921875</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 5.138916015625</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.072021484375</span><br><span class="line">ers called 1.296875</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.070068359375</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.035888671875</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.051025390625</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.057861328125</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.01806640625</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.260009765625</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.03515625</span><br><span class="line"> [RY]kCFRunLoopBeforeTimers called 0.43212890625</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Runloop-in-React-Native"><a href="#Runloop-in-React-Native" class="headerlink" title="Runloop in React Native"></a>Runloop in React Native</h3><h4 id="make-JSThread-long-lived"><a href="#make-JSThread-long-lived" class="headerlink" title="make JSThread long-lived"></a>make JSThread long-lived</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/1bc06f18c613f9a85d5b631493a09682524016f2/React/CxxBridge/RCTCxxBridge.mm#L407">create the JSThread</a>, called <code>com.facebook.react.JavaScript</code>. In react native, this is a secondary thread besides main thread where JavaScript code runs, function calls to native implementation are made etc… </li>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/1bc06f18c613f9a85d5b631493a09682524016f2/React/CxxBridge/RCTCxxBridge.mm#L326">run the runloop explicitly in JSThread</a> to make it long-lived </li>
</ul>
<h4 id="enqueue-a-block-object-on-a-given-runloop"><a href="#enqueue-a-block-object-on-a-given-runloop" class="headerlink" title="enqueue a block object on a given runloop"></a>enqueue a block object on a given runloop</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/1bc06f18c613f9a85d5b631493a09682524016f2/React/CxxBridge/RCTMessageThread.mm#L41">use <code>CFRunLoopPerformBlock</code> to enqueue a block to <code>kCFRunLoopCommonModes</code> mode in current runloop</a>. This function is similar to <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/objectivec/nsobject/1414476-performselector?language=objc">Cocoa’s performSelector:onThread:withObject:waitUntilDone:</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/blob/1bc06f18c613f9a85d5b631493a09682524016f2/React/CxxBridge/RCTMessageThread.mm#L48">wake up runloop. The block will be executed when the runloop runs in <code>kCFRunLoopCommonModes</code> mode </a></li>
</ul>
<h2 id="See-More"><a href="#See-More" class="headerlink" title="See More"></a>See More</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW1">https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW1</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/05/18/runloop/">https://blog.ibireme.com/2015/05/18/runloop/</a></li>
<li><a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/CF/">https://opensource.apple.com/tarballs/CF/</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation">https://developer.apple.com/documentation/corefoundation</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/apple/swift-corelibs-foundation/">https://github.com/apple/swift-corelibs-foundation/</a></li>
</ul>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#Popular Article" >
    <span class="tag-code">Popular Article</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2020/12/24/20201224-How-Image-Loader-and-Cache-work-in-React-Native/">
        <span class="nav-arrow">← </span>
        
          How Image Loader and Cache work in React Native
        
      </a>
    
    
      <a class="nav-right" href="/2021/02/13/20210213-ensure-null-terminated-string/">
        
          Ensure Null-Terminated JS Bundle in React Native
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
  
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">scan qr code and share this article</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo="null"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Background"><span class="toc-nav-text">Background</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#What-is-RunLoop-in-iOS"><span class="toc-nav-text">What is RunLoop in iOS?</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#RunLoop-Mode"><span class="toc-nav-text">RunLoop Mode</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Inputs"><span class="toc-nav-text">Inputs</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Input-Source-CFRunLoopSource"><span class="toc-nav-text">Input Source  - CFRunLoopSource</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Two-categories-of-Input-Source"><span class="toc-nav-text">Two categories of Input Source</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#bits-field"><span class="toc-nav-text">bits field</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CFRunLoopTimer"><span class="toc-nav-text">CFRunLoopTimer</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#a-timer-is-not-a-real-time-mechanism"><span class="toc-nav-text">a timer is not a real-time mechanism</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#RunLoopObserver"><span class="toc-nav-text">RunLoopObserver</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#How-to-use-observer"><span class="toc-nav-text">How to use observer</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#RunLoop-Activity"><span class="toc-nav-text">RunLoop Activity</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Run-Loop-Sequence-of-Events"><span class="toc-nav-text">Run Loop Sequence of Events</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Use-case"><span class="toc-nav-text">Use case</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Detect-hitch-block-in-main-thread"><span class="toc-nav-text">Detect hitch block in main thread</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Runloop-in-React-Native"><span class="toc-nav-text">Runloop in React Native</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#make-JSThread-long-lived"><span class="toc-nav-text">make JSThread long-lived</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#enqueue-a-block-object-on-a-given-runloop"><span class="toc-nav-text">enqueue a block object on a given runloop</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#See-More"><span class="toc-nav-text">See More</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://suelan.github.io/2021/02/13/20210213-dive-into-runloop-ios/';
    var banner = 'undefined'
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2021 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>